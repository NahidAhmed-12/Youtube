<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>YouTube Playlist Player</title>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
  <script src="https://www.youtube.com/iframe_api"></script>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
    :root {
  --primary: #FF4D4D;
  --primary-dark: #E04444;
  --primary-light: rgba(255, 77, 77, 0.15);
  --gradient: linear-gradient(135deg, #FF4D4D 0%, #F9646D 50%, #FF9E7D 100%);
  --dark-1: #0F0F0F;
  --dark-2: #1A1A1A;
  --dark-3: #252525;
  --dark-4: #303030;
  --light-1: #FFFFFF;
  --light-2: #F5F5F5;
  --light-3: #E0E0E0;
  --gray-1: #B3B3B3;
  --gray-2: #808080;
  --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.12);
  --shadow-md: 0 4px 12px rgba(0, 0, 0, 0.15);
  --shadow-lg: 0 10px 20px rgba(0, 0, 0, 0.25);
  --shadow-xl: 0 20px 40px rgba(0, 0, 0, 0.3);
  --transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
  --radius-sm: 8px;
  --radius-md: 12px;
  --radius-lg: 16px;
  --radius-xl: 24px;
  --radius-full: 9999px;
}

/* Base Styles */
body {
  font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
  background-color: var(--dark-1);
  color: var(--light-2);
  line-height: 1.6;
  min-height: 100vh;
  -webkit-font-smoothing: antialiased;
}

.container {
  max-width: 1800px;
  margin: 0 auto;
  padding: 32px;
}

/* Header Styles */
header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 16px 0;
  margin-bottom: 40px;
}

.logo {
  display: flex;
  align-items: center;
  gap: 14px;
  text-decoration: none;
}

.logo-icon {
  width: 48px;
  height: 48px;
  background: var(--gradient);
  border-radius: var(--radius-md);
  display: flex;
  align-items: center;
  justify-content: center;
  color: var(--light-1);
  font-size: 20px;
  box-shadow: 0 4px 20px rgba(255, 77, 77, 0.4);
  transition: var(--transition);
}

.logo:hover .logo-icon {
  transform: rotate(15deg) scale(1.1);
}

.logo-text {
  font-size: 28px;
  font-weight: 800;
  background: var(--gradient);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  letter-spacing: -0.5px;
}

/* Input Section */
.input-section {
  margin-bottom: 40px;
}

.input-container {
  display: flex;
  border-radius: var(--radius-lg);
  overflow: hidden;
  transition: var(--transition);
  background-color: var(--dark-3);
  border: 2px solid var(--dark-4);
  box-shadow: var(--shadow-lg);
}

.input-container:focus-within {
  border-color: var(--primary);
  box-shadow: 0 0 0 4px var(--primary-light), var(--shadow-lg);
}

.input-container input {
  flex: 1;
  padding: 18px 24px;
  border: none;
  font-size: 16px;
  outline: none;
  background-color: transparent;
  color: var(--light-2);
  font-weight: 500;
}

.input-container input::placeholder {
  color: var(--gray-2);
  font-weight: 400;
}

.input-container button {
  background: var(--gradient);
  color: var(--light-1);
  border: none;
  padding: 0 32px;
  font-size: 16px;
  font-weight: 600;
  cursor: pointer;
  transition: var(--transition);
  display: flex;
  align-items: center;
  gap: 12px;
  position: relative;
  overflow: hidden;
}

.input-container button::after {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: linear-gradient(rgba(255,255,255,0.2), rgba(255,255,255,0.2));
  opacity: 0;
  transition: var(--transition);
}

.input-container button:hover::after {
  opacity: 1;
}

.input-container button i {
  font-size: 18px;
  transition: transform 0.3s ease;
}

.input-container button:hover i {
  transform: scale(1.2);
}

/* Player Section */
.player-section {
  display: flex;
  flex-direction: column;
  gap: 24px;
}

.player-container {
  background-color: var(--dark-2);
  border-radius: var(--radius-xl);
  overflow: hidden;
  box-shadow: var(--shadow-xl);
  border: 2px solid var(--dark-4);
  transition: var(--transition);
}

.player-container:hover {
  transform: translateY(-2px);
  box-shadow: var(--shadow-xl);
}

.player-wrapper {
  position: relative;
  padding-bottom: 56.25%;
  height: 0;
  overflow: hidden;
  background-color: #000;
}

#player {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
}

/* Player Controls */
.player-controls {
  display: flex;
  justify-content: center;
  gap: 20px;
  padding: 24px;
  background-color: var(--dark-2);
  border-radius: 0 0 var(--radius-xl) var(--radius-xl);
  border-top: 2px solid var(--dark-4);
}

.player-controls button {
  background: var(--gradient);
  color: var(--light-1);
  border: none;
  padding: 14px 32px;
  border-radius: var(--radius-md);
  cursor: pointer;
  font-size: 16px;
  font-weight: 600;
  transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
  display: flex;
  align-items: center;
  gap: 12px;
  box-shadow: var(--shadow-md);
  position: relative;
  overflow: hidden;
  min-width: 160px;
  justify-content: center;
}

.player-controls button:hover {
  transform: translateY(-3px);
  box-shadow: var(--shadow-lg);
}

.player-controls button:active {
  transform: translateY(1px);
}

.player-controls button:disabled {
  background: var(--dark-4);
  color: var(--gray-2);
  cursor: not-allowed;
  transform: none;
  box-shadow: none;
}

.player-controls button::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: linear-gradient(rgba(255,255,255,0.15), rgba(255,255,255,0.15));
  opacity: 0;
  transition: var(--transition);
}

.player-controls button:hover::before {
  opacity: 1;
}

.player-controls button i {
  font-size: 18px;
  transition: transform 0.3s ease;
}

.player-controls button:hover i {
  transform: scale(1.2);
}

/* Playlist Section */
.playlist-section {
  height: calc(100vh - 220px);
  position: sticky;
  top: 32px;
}

.playlist-container {
  background-color: var(--dark-2);
  border-radius: var(--radius-xl);
  box-shadow: var(--shadow-xl);
  overflow: hidden;
  height: 100%;
  display: flex;
  flex-direction: column;
  border: 2px solid var(--dark-4);
}

.playlist-header {
  padding: 20px 24px;
  background-color: var(--dark-3);
  color: var(--light-1);
  display: flex;
  justify-content: space-between;
  align-items: center;
  border-bottom: 2px solid var(--dark-4);
}

.playlist-title {
  font-size: 20px;
  font-weight: 700;
  display: flex;
  align-items: center;
  gap: 12px;
}

.playlist-title i {
  background: var(--gradient);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  font-size: 22px;
}

.playlist-count {
  background-color: var(--dark-4);
  color: var(--light-2);
  padding: 6px 14px;
  border-radius: var(--radius-full);
  font-size: 14px;
  font-weight: 700;
}

.playlist-items {
  flex: 1;
  overflow-y: auto;
  padding: 16px;
}

/* Playlist Item */
.playlist-item {
  display: flex;
  padding: 16px;
  border-radius: var(--radius-lg);
  cursor: pointer;
  transition: var(--transition);
  position: relative;
  margin-bottom: 12px;
  background-color: var(--dark-3);
  border: 2px solid var(--dark-4);
}

.playlist-item:hover {
  background-color: var(--dark-4);
  transform: translateY(-3px);
  box-shadow: var(--shadow-md);
  border-color: var(--primary);
}

.playlist-item.active {
  background-color: var(--primary-light);
  border-color: var(--primary);
  transform: translateY(-3px);
  box-shadow: 0 10px 20px rgba(255, 77, 77, 0.2);
}

.playlist-item.active .video-title {
  color: var(--light-1);
  font-weight: 600;
}

.playlist-item.active .video-channel {
  color: var(--light-3);
}

.thumbnail {
  width: 160px;
  height: 90px;
  background-color: var(--dark-4);
  margin-right: 20px;
  flex-shrink: 0;
  background-size: cover;
  background-position: center;
  position: relative;
  border-radius: var(--radius-sm);
  overflow: hidden;
  transition: var(--transition);
  box-shadow: var(--shadow-sm);
}

.playlist-item:hover .thumbnail {
  transform: scale(1.03);
  box-shadow: var(--shadow-md);
}

.thumbnail::after {
  content: attr(data-duration);
  position: absolute;
  bottom: 8px;
  right: 8px;
  background-color: rgba(0, 0, 0, 0.8);
  color: var(--light-1);
  padding: 4px 10px;
  font-size: 12px;
  border-radius: var(--radius-sm);
  font-weight: 600;
}

.video-info {
  flex: 1;
  overflow: hidden;
  display: flex;
  flex-direction: column;
  justify-content: center;
}

.video-title {
  font-weight: 600;
  margin-bottom: 8px;
  display: -webkit-box;
  -webkit-line-clamp: 2;
  -webkit-box-orient: vertical;
  overflow: hidden;
  font-size: 16px;
  color: var(--light-2);
  transition: var(--transition);
}

.video-channel {
  color: var(--gray-1);
  font-size: 14px;
  margin-bottom: 12px;
  display: -webkit-box;
  -webkit-line-clamp: 1;
  -webkit-box-orient: vertical;
  overflow: hidden;
  transition: var(--transition);
}

.progress-container {
  margin-top: 10px;
}

.progress-info {
  display: flex;
  justify-content: space-between;
  font-size: 13px;
  color: var(--gray-1);
  margin-bottom: 8px;
  font-weight: 500;
}

.progress-bar {
  height: 6px;
  background-color: var(--dark-4);
  border-radius: 3px;
  overflow: hidden;
}

.progress {
  height: 100%;
  background: var(--gradient);
  border-radius: 3px;
  transition: width 0.5s ease;
}

/* Empty State */
.empty-state {
  height: 100%;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  padding: 48px 24px;
  text-align: center;
  color: var(--gray-1);
}

.empty-icon {
  width: 100px;
  height: 100px;
  background: var(--gradient);
  border-radius: var(--radius-xl);
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 36px;
  color: var(--light-1);
  margin-bottom: 28px;
  box-shadow: var(--shadow-lg);
  transition: var(--transition);
}

.empty-state:hover .empty-icon {
  transform: scale(1.1) rotate(10deg);
}

.empty-title {
  font-size: 20px;
  margin-bottom: 12px;
  font-weight: 700;
  color: var(--light-2);
}

.empty-text {
  font-size: 15px;
  max-width: 300px;
  margin: 0 auto 28px;
  line-height: 1.6;
}

.empty-button {
  background: var(--gradient);
  color: var(--light-1);
  border: none;
  padding: 14px 28px;
  border-radius: var(--radius-md);
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
  display: flex;
  align-items: center;
  gap: 10px;
  box-shadow: var(--shadow-md);
  position: relative;
  overflow: hidden;
}

.empty-button:hover {
  transform: translateY(-3px);
  box-shadow: var(--shadow-lg);
}

.empty-button:active {
  transform: translateY(1px);
}

.empty-button::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: linear-gradient(rgba(255,255,255,0.15), rgba(255,255,255,0.15));
  opacity: 0;
  transition: var(--transition);
}

.empty-button:hover::before {
  opacity: 1;
}

.empty-button i {
  font-size: 18px;
  transition: transform 0.3s ease;
}

.empty-button:hover i {
  transform: scale(1.2);
}

/* Custom Scrollbar */
::-webkit-scrollbar {
  width: 10px;
}

::-webkit-scrollbar-track {
  background: var(--dark-3);
  border-radius: 5px;
}

::-webkit-scrollbar-thumb {
  background: var(--gray-2);
  border-radius: 5px;
}

::-webkit-scrollbar-thumb:hover {
  background: var(--primary);
}

/* Responsive Adjustments */
@media (max-width: 1200px) {
  .container {
    padding: 28px;
  }
  
  .main-content {
    grid-template-columns: 1fr;
  }
  
  .playlist-section {
    height: auto;
    position: static;
  }
  
  .playlist-items {
    max-height: 500px;
  }
  
  .thumbnail {
    width: 140px;
    height: 80px;
  }
}

@media (max-width: 768px) {
  .container {
    padding: 24px;
  }
  
  header {
    flex-direction: column;
    align-items: flex-start;
    gap: 20px;
    margin-bottom: 32px;
  }
  
  .logo {
    gap: 12px;
  }
  
  .logo-icon {
    width: 44px;
    height: 44px;
    font-size: 18px;
  }
  
  .logo-text {
    font-size: 24px;
  }
  
  .input-container {
    flex-direction: column;
  }
  
  .input-container input {
    padding: 16px 20px;
  }
  
  .input-container button {
    padding: 16px;
    justify-content: center;
  }
  
  .player-controls {
    flex-direction: column;
    gap: 16px;
  }
  
  .player-controls button {
    width: 100%;
  }
  
  .thumbnail {
    width: 120px;
    height: 70px;
  }
}

@media (max-width: 480px) {
  .container {
    padding: 20px;
  }
  
  .playlist-item {
    flex-direction: column;
  }
  
  .thumbnail {
    width: 100%;
    height: 0;
    padding-bottom: 56.25%;
    margin-right: 0;
    margin-bottom: 16px;
  }
  
  .empty-icon {
    width: 80px;
    height: 80px;
    font-size: 30px;
  }
  
  .empty-title {
    font-size: 18px;
  }
  
  .empty-text {
    font-size: 14px;
  }
}

/* Animation */
@keyframes fadeIn {
  from { opacity: 0; transform: translateY(10px); }
  to { opacity: 1; transform: translateY(0); }
}

.playlist-item {
  animation: fadeIn 0.5s ease forwards;
  opacity: 0;
}

.playlist-item:nth-child(1) { animation-delay: 0.1s; }
.playlist-item:nth-child(2) { animation-delay: 0.2s; }
.playlist-item:nth-child(3) { animation-delay: 0.3s; }
.playlist-item:nth-child(4) { animation-delay: 0.4s; }
.playlist-item:nth-child(5) { animation-delay: 0.5s; }
.playlist-item:nth-child(n+6) { animation-delay: 0.6s; }

/* Floating Action Button */
.fab {
  position: fixed;
  bottom: 32px;
  right: 32px;
  width: 60px;
  height: 60px;
  border-radius: 50%;
  background: var(--gradient);
  color: white;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 24px;
  box-shadow: var(--shadow-xl);
  z-index: 100;
  cursor: pointer;
  transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
  display: none;
}

.fab:hover {
  transform: translateY(-5px) scale(1.1);
  box-shadow: 0 15px 30px rgba(255, 77, 77, 0.4);
}

@media (max-width: 768px) {
  .fab {
    display: flex;
  }
}
</style>
</head>
<body>
  <div class="container">
    <header>
      <a href="#" class="logo">
        <div class="logo-icon">
          <i class="fas fa-play"></i>
        </div>
        <div class="logo-text">Playlist Player</div>
      </a>

    </header>
    
    <div class="main-content">
      <div class="player-section">
        <div class="player-container">
          <div class="player-wrapper">
            <div id="player"></div>
          </div>
        </div>
        
        <div class="player-controls">
          <button onclick="playPreviousVideo()" id="prevBtn" disabled>
            <i class="fas fa-step-backward"></i> Previous
          </button>
          <button onclick="playNextVideo()" id="nextBtn" disabled>
            Next <i class="fas fa-step-forward"></i>
          </button>
        </div>
      </div>
      
      <div class="playlist-section">
        <div class="playlist-container">
          <div class="playlist-header">
            <div class="playlist-title">
              <i class="fas fa-list-ul"></i> Playlist
            </div>
            <div class="playlist-count" id="playlistCount">0 videos</div>
          </div>
          <div class="playlist-items" id="videoList">
            <div class="empty-state">
              <div class="empty-icon">
                <i class="fas fa-music"></i>
              </div>
              <div class="empty-title">Your playlist is empty</div>
              <div class="empty-text">Add YouTube videos to create your personalized playlist and start watching</div>
              <button class="empty-button" onclick="document.getElementById('videoLink').focus()">
                <i class="fas fa-plus"></i> Add First Video
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Firebase config
    const firebaseConfig = {
      databaseURL: "https://baul-vercel-app-default-rtdb.firebaseio.com/"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let player;
    let videoId = '';
    let currentPlayingItem = null;
    let lastWatchedVideoId = null;
    let isSaving = false;
    let playlistVideos = [];
    let currentVideoIndex = -1;
    let lastUpdateTime = 0;

    // Function to extract YouTube video ID from different formats
    function getVideoId(link) {
      try {
        let url = new URL(link);
        if (url.hostname.includes("youtu.be")) {
          return url.pathname.substring(1); // youtu.be/VIDEO_ID
        } else {
          return url.searchParams.get("v");
        }
      } catch (e) {
        return null;
      }
    }

    function saveAndLoadVideo() {
      const link = document.getElementById("videoLink").value.trim();
      videoId = getVideoId(link);

      if (!videoId) {
        alert("Please enter a valid YouTube link.");
        return;
      }

      const videoRef = db.ref("videos/" + videoId);
      videoRef.set({
        url: link,
        time: 0,
        addedAt: firebase.database.ServerValue.TIMESTAMP,
        lastWatched: firebase.database.ServerValue.TIMESTAMP,
        duration: "0:00",
        durationSec: 1
      }).then(() => {
        document.getElementById("videoLink").value = "";
      });
    }

    function loadPlayer(videoId, startTime) {
      if (player) {
        player.loadVideoById({ videoId: videoId, startSeconds: startTime });
      } else {
        player = new YT.Player('player', {
          height: '390',
          width: '640',
          videoId: videoId,
          playerVars: {
            start: startTime,
            rel: 0,
            modestbranding: 1
          },
          events: {
            'onStateChange': onPlayerStateChange,
            'onReady': onPlayerReady
          }
        });
      }
      
      // Update last watched timestamp
      db.ref("videos/" + videoId + "/lastWatched").set(firebase.database.ServerValue.TIMESTAMP);
      lastWatchedVideoId = videoId;
      
      // Update URL hash
      window.location.hash = videoId;
      
      // Update current video index
      currentVideoIndex = playlistVideos.findIndex(video => video.id === videoId);
      updateNavButtons();
    }

    function saveCurrentTime() {
      if (!player || !videoId || isSaving) return;
      
      const currentTime = Math.floor(player.getCurrentTime());
      const now = Date.now();
      
      // Only save if at least 5 seconds have passed since last save
      if (now - lastUpdateTime < 5000) return;
      
      isSaving = true;
      lastUpdateTime = now;
      
      db.ref("videos/" + videoId).update({
        time: currentTime,
        lastWatched: firebase.database.ServerValue.TIMESTAMP
      }).then(() => {
        console.log("Time saved:", currentTime);
        isSaving = false;
        updateProgressBarForVideo(videoId, currentTime);
      }).catch(error => {
        console.error("Error saving time:", error);
        isSaving = false;
      });
    }

    function onPlayerReady(event) {
      // Set up periodic saving (every 5 seconds)
      setInterval(saveCurrentTime, 5000);
      
      // Update current video's duration if not set
      if (player && player.getDuration) {
        const duration = player.getDuration();
        if (duration > 0) {
          db.ref("videos/" + videoId).update({
            duration: formatTime(duration),
            durationSec: duration
          });
        }
      }
    }

    function onPlayerStateChange(event) {
      if (event.data === YT.PlayerState.PAUSED || event.data === YT.PlayerState.ENDED) {
        saveCurrentTime();
      }
      
      if (event.data === YT.PlayerState.PLAYING) {
        highlightCurrentVideo();
      }
    }

    function setupRealtimeListener() {
      db.ref("videos").orderByChild("addedAt").on("value", (snapshot) => {
        const list = document.getElementById("videoList");
        
        if (!snapshot.exists()) {
          if (list.querySelector('.empty-state') === null) {
            list.innerHTML = `
              <div class="empty-state">
                <div class="empty-icon">
                  <i class="fas fa-music"></i>
                </div>
                <div class="empty-title">Your playlist is empty</div>
                <div class="empty-text">Add YouTube videos to create your personalized playlist and start watching</div>
                <button class="empty-button" onclick="document.getElementById('videoLink').focus()">
                  <i class="fas fa-plus"></i> Add First Video
                </button>
              </div>
            `;
          }
          document.getElementById("playlistCount").textContent = "0 videos";
          playlistVideos = [];
          currentVideoIndex = -1;
          updateNavButtons();
          return;
        }

        const newPlaylistVideos = [];
        let mostRecentVideo = null;
        let mostRecentTime = 0;

        snapshot.forEach(child => {
          const vid = child.key;
          const data = child.val();
          const duration = data.duration || "0:00";
          
          newPlaylistVideos.push({
            id: vid,
            data: data,
            duration: duration
          });

          // Track the most recently watched video
          if (data.lastWatched && data.lastWatched > mostRecentTime) {
            mostRecentTime = data.lastWatched;
            mostRecentVideo = vid;
          }
        });

        // Update playlist count
        document.getElementById("playlistCount").textContent = `${newPlaylistVideos.length} ${newPlaylistVideos.length === 1 ? 'video' : 'videos'}`;

        // Only re-render if the playlist has changed
        if (JSON.stringify(playlistVideos.map(v => v.id)) !== JSON.stringify(newPlaylistVideos.map(v => v.id))) {
          list.innerHTML = "";
          newPlaylistVideos.forEach((video, index) => {
            const item = document.createElement("div");
            item.className = "playlist-item";
            if (video.id === videoId) {
              item.classList.add("active");
              currentPlayingItem = item;
            }
            item.setAttribute("data-video-id", video.id);
            item.onclick = () => loadSavedVideo(video.id);
            
            item.innerHTML = `
              <div class="thumbnail" style="background-image: url(https://img.youtube.com/vi/${video.id}/mqdefault.jpg)" data-duration="${video.duration}"></div>
              <div class="video-info">
                <div class="video-title">${video.data.title || "Untitled Video"}</div>
                <div class="video-channel">${video.data.channel || "Unknown channel"}</div>
                <div class="progress-container">
                  <div class="progress-info">
                    <span>${formatTime(video.data.time || 0)}</span>
                    <span>${video.duration}</span>
                  </div>
                  <div class="progress-bar">
                    <div class="progress" style="width: ${calculateProgress(video.data.time || 0, video.data.durationSec || 1)}%"></div>
                  </div>
                </div>
              </div>
            `;
            
            list.appendChild(item);
          });
        } else {
          // Just update progress bars for existing items
          newPlaylistVideos.forEach(video => {
            updateProgressBarForVideo(video.id, video.data.time || 0);
          });
        }

        playlistVideos = newPlaylistVideos;

        // Auto-play the most recently watched video if available and no hash in URL
        if (mostRecentVideo && !videoId && !window.location.hash) {
          loadSavedVideo(mostRecentVideo);
        }
        
        // Update current video index if we have a videoId but no index
        if (videoId && currentVideoIndex === -1) {
          currentVideoIndex = playlistVideos.findIndex(video => video.id === videoId);
          updateNavButtons();
        }
      });
    }

    function calculateProgress(currentTime, duration) {
      if (duration <= 0) return 0;
      const progress = (currentTime / duration) * 100;
      return Math.min(100, Math.max(0, progress)); // Ensure between 0-100
    }

    function formatTime(seconds) {
      const mins = Math.floor(seconds / 60);
      const secs = Math.floor(seconds % 60);
      return `${mins}:${secs < 10 ? '0' : ''}${secs}`;
    }

    function loadSavedVideo(vid) {
      videoId = vid;
      db.ref("videos/" + vid).once("value").then(snapshot => {
        const video = snapshot.val();
        const startTime = video.time || 0;
        loadPlayer(videoId, startTime);
        highlightCurrentVideo();
      });
    }

    function playNextVideo() {
      if (currentVideoIndex < playlistVideos.length - 1) {
        const nextVideo = playlistVideos[currentVideoIndex + 1];
        loadSavedVideo(nextVideo.id);
      }
    }

    function playPreviousVideo() {
      if (currentVideoIndex > 0) {
        const prevVideo = playlistVideos[currentVideoIndex - 1];
        loadSavedVideo(prevVideo.id);
      }
    }

    function updateNavButtons() {
      const prevBtn = document.getElementById("prevBtn");
      const nextBtn = document.getElementById("nextBtn");
      
      prevBtn.disabled = currentVideoIndex <= 0;
      nextBtn.disabled = currentVideoIndex >= playlistVideos.length - 1 || currentVideoIndex === -1;
    }

    function highlightCurrentVideo() {
      if (currentPlayingItem) {
        currentPlayingItem.classList.remove("active");
      }
      
      const items = document.querySelectorAll(".playlist-item");
      items.forEach(item => {
        if (item.getAttribute("data-video-id") === videoId) {
          item.classList.add("active");
          currentPlayingItem = item;
          // Scroll to the item if it's not in view
          item.scrollIntoView({ behavior: "smooth", block: "nearest" });
        }
      });
    }

    function updateProgressBarForVideo(vid, currentTime) {
      const item = document.querySelector(`.playlist-item[data-video-id="${vid}"]`);
      if (!item) return;
      
      const progressBar = item.querySelector('.progress');
      const timeDisplay = item.querySelector('.progress-info span:first-child');
      const durationDisplay = item.querySelector('.progress-info span:last-child');
      
      if (progressBar && timeDisplay) {
        // Get duration from data attribute or calculate
        let duration = 1;
        const videoData = playlistVideos.find(v => v.id === vid);
        if (videoData && videoData.data.durationSec) {
          duration = videoData.data.durationSec;
        }
        
        const percentage = calculateProgress(currentTime, duration);
        progressBar.style.width = `${percentage}%`;
        timeDisplay.textContent = formatTime(currentTime);
      }
    }

    // Save time when page is about to unload
    window.addEventListener('beforeunload', function(e) {
      saveCurrentTime();
    });

    // Load video list on page load
    window.onload = function() {
      setupRealtimeListener();
      
      // Check if there's a video ID in URL hash
      const hashVideoId = window.location.hash.substring(1);
      if (hashVideoId) {
        loadSavedVideo(hashVideoId);
      }
      
      // Add event listener for Enter key in input field
      document.getElementById("videoLink").addEventListener("keypress", function(e) {
        if (e.key === "Enter") {
          saveAndLoadVideo();
        }
      });
    };
  </script>
</body>
</html>
